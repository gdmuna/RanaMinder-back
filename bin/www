#!/usr/bin/env node

/**
 * Nekorify 后端服务入口文件
 */

// ==================== 模块依赖 ====================

// 环境变量配置
require("dotenv").config({
  path: `.env.${process.env.NODE_ENV || "development"}`,
});

// Express 及第三方中间件
const express = require("express");
const cookieParser = require("cookie-parser");
const logger = require("morgan");
const cors = require("cors");

// 自定义中间件
const errorHandlerMiddleware = require("../middlewares/errorHandle");
const successResponse = require("../middlewares/successResponse");
const apiProtected = require("../middlewares/apiProtected");

// 路由
const router = require("../routes/index");

// ==================== 应用配置 ====================

const app = express();

app.use(
  cors({
    origin: "*",
    methods: ["GET", "POST", "PUT", "DELETE"],
  })
);
app.use(logger("dev"));
app.use(express.json());
app.use(express.urlencoded({ extended: true }));
app.use(cookieParser());
app.use(successResponse);

app.use(apiProtected);
app.use("/api", router);

app.use(errorHandlerMiddleware);

// ==================== 服务器启动 ====================

const server = app.listen(
  process.env.PORT || 33001,
  process.env.HOST || "127.0.0.1",
  () => {
    console.log(
      "Server running at http://%s:%s",
      process.env.HOST || "127.0.0.1",
      process.env.PORT || 33001
    );
    console.log("Environment=%s", process.env.NODE_ENV);
  }
);